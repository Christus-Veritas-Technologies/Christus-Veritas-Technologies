// Christus Veritas Technologies - ERP Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATIONS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  email     String
  phone     String?
  address   String?
  city      String?
  country   String   @default("Zimbabwe")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members        OrganizationMember[]
  billingAccount BillingAccount?
  services       Service[]
  apiKeys        ApiKey[]
  usageEvents    UsageEvent[]
  supportTickets SupportTicket[]

  @@index([slug])
  @@index([email])
}

// ============================================
// USERS & MEMBERSHIP
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  phoneNumber   String?
  emailVerified DateTime?
  image         String?

  // Email verification
  emailVerificationToken   String?   @unique
  emailVerificationExpires DateTime?

  // Onboarding
  onboardingCompleted Boolean @default(false)

  // Business information
  businessName    String?
  businessAddress String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships         OrganizationMember[]
  sessions            Session[]
  accounts            Account[]
  clientServices      ClientService[]
  apiKeys             ApiKey[]
  projects            Project[]
  quotedProjects      Project[]            @relation("QuotedProjects")
  projectMessages     ProjectMessage[]
  savedPaymentMethods SavedPaymentMethod[]
  notifications       Notification[]
  orders              Order[]

  // Admin flag for CVT internal staff
  isAdmin Boolean @default(false)

  @@index([email])
  @@index([emailVerificationToken])
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
}

// ============================================
// AUTHENTICATION (better-auth compatible)
// ============================================

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
}

// ============================================
// INVITATIONS
// ============================================

model Invitation {
  id        String           @id @default(cuid())
  email     String
  name      String
  role      InvitationRole   @default(CLIENT)
  status    InvitationStatus @default(PENDING)
  
  // Token for invitation link
  token     String   @unique
  expiresAt DateTime

  // Generated credentials (password is hashed)
  tempPassword String?

  // Service provisioning (for clients only)
  provisionServiceId String?
  provisionUnits     Int?
  provisionRecurring Boolean @default(true)

  // Tracking
  sentAt     DateTime?
  acceptedAt DateTime?
  userId     String?   // Set when invitation is accepted

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([token])
  @@index([status])
}

enum InvitationRole {
  ADMIN
  CLIENT
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

// ============================================
// BILLING
// ============================================

model BillingAccount {
  id             String               @id @default(cuid())
  organizationId String               @unique
  status         BillingAccountStatus @default(ACTIVE)

  gracePeriodDays Int     @default(14)
  balance         Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  payments     Payment[]
  credits      Credit[]

  @@index([organizationId])
  @@index([status])
}

enum BillingAccountStatus {
  ACTIVE
  OVERDUE
  SUSPENDED
}

model Invoice {
  id               String @id @default(cuid())
  billingAccountId String
  invoiceNumber    String @unique

  periodStart DateTime
  periodEnd   DateTime

  subtotal   Int
  tax        Int           @default(0)
  total      Int
  amountPaid Int           @default(0)
  amountDue  Int
  status     InvoiceStatus @default(DRAFT)

  issuedAt    DateTime?
  dueAt       DateTime?
  paidAt      DateTime?
  finalizedAt DateTime?

  paymentToken          String?   @unique
  paymentTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  billingAccount BillingAccount    @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)
  lineItems      InvoiceLineItem[]
  payments       Payment[]

  @@index([billingAccountId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([paymentToken])
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  PARTIAL
  OVERDUE
  VOID
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitPrice   Int
  total       Int
  serviceId   String?

  createdAt DateTime @default(now())

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id])

  @@index([invoiceId])
  @@index([serviceId])
}

model Payment {
  id               String        @id @default(cuid())
  billingAccountId String
  invoiceId        String?
  amount           Int
  currency         String        @default("USD")
  method           PaymentMethod
  status           PaymentStatus @default(PENDING)

  externalId     String?
  externalStatus String?

  initiatedAt DateTime  @default(now())
  completedAt DateTime?
  failedAt    DateTime?

  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  billingAccount BillingAccount @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)
  invoice        Invoice?       @relation(fields: [invoiceId], references: [id])

  @@index([billingAccountId])
  @@index([invoiceId])
  @@index([status])
  @@index([externalId])
}

enum PaymentMethod {
  PAYNOW_ECOCASH
  PAYNOW_ONEMONEY
  PAYNOW_INNBUCKS
  PAYNOW_VISA
  PAYNOW_MASTERCARD
  BANK_TRANSFER
  CASH
  CREDIT
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

// Order - Tracks purchases of services/products
model Order {
  id        String      @id @default(cuid())
  userId    String
  itemType  String      // SERVICE or PRODUCT
  itemId    String      // ID of the service or product
  quantity  Int         @default(1)
  amount    Int         // Amount in cents
  paymentId String?
  reference String      @unique
  status    OrderStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([paymentId])
  @@index([reference])
  @@index([status])
}

enum OrderStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

model Credit {
  id               String @id @default(cuid())
  billingAccountId String
  amount           Int
  reason           String
  issuedById       String?

  createdAt DateTime @default(now())

  billingAccount BillingAccount @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)

  @@index([billingAccountId])
}

// Saved Payment Method - For storing customer card/mobile money info
model SavedPaymentMethod {
  id             String                  @id @default(cuid())
  userId         String
  type           SavedPaymentMethodType
  isDefault      Boolean                 @default(false)

  // For cards (VISA/MASTERCARD) - store masked/tokenized info only
  cardLast4      String?
  cardBrand      String? // VISA, MASTERCARD
  cardExpMonth   Int?
  cardExpYear    Int?
  cardHolderName String?

  // For mobile money (Ecocash, OneMoney, Innbucks)
  mobileNumber   String?
  mobileProvider String? // ECOCASH, ONEMONEY, INNBUCKS

  // Nickname for the payment method
  nickname       String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
}

enum SavedPaymentMethodType {
  CARD
  MOBILE_MONEY
}

// ============================================
// SERVICES
// ============================================

// Service Definition - Template for services that can be provisioned to clients
model ServiceDefinition {
  id          String  @id @default(cuid())
  name        String
  description String?

  // Pricing
  oneOffPrice            Int?     // One-time setup/purchase fee in cents (optional)
  recurringPrice         Int      @default(0) // Recurring fee in cents
  recurringPricePerUnit  Boolean  @default(false) // If true, recurringPrice is per unit
  billingCycleDays       Int      @default(30) // Days between recurring bills (30 = monthly)

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  clientServices ClientService[]

  @@index([isActive])
}

// Client Service - Instance of a service provisioned to a specific client
model ClientService {
  id                  String @id @default(cuid())
  userId              String
  serviceDefinitionId String

  // Instance-specific settings
  units                    Int      @default(1) // Number of units the client has
  oneOffPricePaid          Boolean  @default(false) // Whether one-time fee has been paid
  oneOffPaidInCash         Boolean  @default(false) // Whether one-time fee was paid in cash (outside system)
  oneOffCashConfirmed      Boolean  @default(false) // Admin confirmed cash payment received
  oneOffCashConfirmedAt    DateTime? // When admin confirmed cash payment
  oneOffCashConfirmedBy    String?  // Admin user ID who confirmed
  
  currentMonthPaidInCash   Boolean  @default(false) // This month's recurring fee paid in cash
  currentMonthCashConfirmed Boolean @default(false) // Admin confirmed this month's cash payment
  currentMonthCashConfirmedAt DateTime? // When confirmed
  
  enableRecurring          Boolean  @default(true) // Whether to bill recurring for this client
  customRecurringPrice     Int?     // Optional custom recurring price for this client

  // Billing dates
  dateJoined     DateTime  @default(now()) // When client started using this service
  nextBillingDate DateTime? // Next date to bill recurring fee
  lastBilledDate  DateTime? // Last date recurring was billed

  status ClientServiceStatus @default(ACTIVE)

  activatedAt DateTime  @default(now())
  suspendedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  serviceDefinition ServiceDefinition @relation(fields: [serviceDefinitionId], references: [id], onDelete: Cascade)

  @@unique([userId, serviceDefinitionId])
  @@index([userId])
  @@index([serviceDefinitionId])
  @@index([status])
  @@index([nextBillingDate])
}

enum ClientServiceStatus {
  PENDING_PAYMENT // Waiting for cash payment confirmation
  ACTIVE
  SUSPENDED
  CANCELLED
}

// Legacy Service model - keeping for existing org-based services
model Service {
  id             String        @id @default(cuid())
  organizationId String
  type           ServiceType
  name           String
  hardwareSerial String?
  monthlyFee     Int
  status         ServiceStatus @default(ACTIVE)

  activatedAt DateTime  @default(now())
  suspendedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lineItems    InvoiceLineItem[]

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([hardwareSerial])
}

enum ServiceType {
  POS_TERMINAL
  POS_MAINTENANCE
  FUTURE_PRODUCT
}

enum ServiceStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

// ============================================
// API KEYS
// ============================================

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String?  // Optional - for org-level keys
  userId         String?  // Optional - for user-level keys
  name           String
  keyHash        String   @unique
  keyPrefix      String
  scopes         String[]
  isActive       Boolean  @default(true)
  rateLimit      Int      @default(1000)
  expiresAt      DateTime?
  lastUsedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  usageEvents  UsageEvent[]

  @@index([organizationId])
  @@index([userId])
  @@index([keyPrefix])
  @@index([isActive])
}

// ============================================
// USAGE EVENTS
// ============================================

model UsageEvent {
  id             String   @id @default(cuid())
  organizationId String
  apiKeyId       String?
  eventType      String
  eventData      Json?
  quantity       Int      @default(1)
  timestamp      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiKey       ApiKey?      @relation(fields: [apiKeyId], references: [id])

  @@index([organizationId])
  @@index([apiKeyId])
  @@index([eventType])
  @@index([timestamp])
}

// ============================================
// SUPPORT
// ============================================

model SupportTicket {
  id             String              @id @default(cuid())
  organizationId String
  subject        String
  description    String
  status         SupportTicketStatus @default(OPEN)
  priority       SupportPriority     @default(NORMAL)
  assignedToId   String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages     SupportMessage[]

  @@index([organizationId])
  @@index([status])
  @@index([assignedToId])
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CLIENT
  RESOLVED
  CLOSED
}

enum SupportPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model SupportMessage {
  id         String  @id @default(cuid())
  ticketId   String
  senderId   String
  message    String
  isInternal Boolean @default(false)

  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([senderId])
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  actorType  String
  action     String
  entityType String
  entityId   String
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([timestamp])
}

// ============================================
// USER NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  read      Boolean          @default(false)
  
  // Optional link to related entity
  entityType String?
  entityId   String?
  
  createdAt DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
}

enum NotificationType {
  INFO
  SUCCESS
  WARNING
  ERROR
  PAYMENT
  INVOICE
  PROJECT
  SERVICE
  SYSTEM
}

// ============================================
// EMAIL NOTIFICATIONS
// ============================================

model EmailLog {
  id           String      @id @default(cuid())
  to           String
  subject      String
  template     String
  status       EmailStatus @default(QUEUED)
  entityType   String?
  entityId     String?
  sentAt       DateTime?
  failedAt     DateTime?
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([to])
  @@index([status])
  @@index([entityType, entityId])
}

enum EmailStatus {
  QUEUED
  SENT
  FAILED
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String

  updatedAt DateTime @updatedAt

  @@index([key])
}

// ============================================
// MARKETPLACE
// ============================================

model Product {
  id          String  @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  price       Int     // Price in cents
  currency    String  @default("USD")

  category    String?
  isActive    Boolean @default(true)
  isFeatured  Boolean @default(false)
  stockCount  Int?    // null = unlimited

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([category])
  @@index([isFeatured])
}

model MarketplaceService {
  id          String  @id @default(cuid())
  name        String
  description String?
  imageUrl    String?
  
  // Pricing
  oneOffPrice    Int @default(0) // One-time fee in cents
  recurringPrice Int @default(0) // Recurring fee in cents
  billingCycle   String @default("monthly") // monthly, yearly, etc.
  currency       String @default("USD")

  category   String?
  isActive   Boolean @default(true)
  isFeatured Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive])
  @@index([category])
  @@index([isFeatured])
}

// ============================================
// PROJECTS (Custom Software Requests)
// ============================================

model Project {
  id          String        @id @default(cuid())
  userId      String
  title       String
  description String        @db.Text
  
  // Project requirements from user
  requirements    String?   @db.Text
  timeline        String?   // e.g., "2 weeks", "1 month"
  budget          Int?      // User's estimated budget in cents (optional)
  
  // CVT Quote
  quotedPrice           Int?      // Price quoted by CVT in cents
  quotedTimeline        String?   // e.g., "3 weeks"
  quotedAt              DateTime?
  quotedById            String?   // Admin who quoted
  quoteNotes            String?   @db.Text
  
  // Payment tracking
  pricePaidInCash       Boolean   @default(false) // Main project price paid in cash
  priceCashConfirmed    Boolean   @default(false) // Admin confirmed cash payment
  priceCashConfirmedAt  DateTime? // When confirmed
  priceCashConfirmedBy  String?   // Admin who confirmed
  
  // Monthly maintenance
  monthlyMaintenanceFee Int?      // Optional monthly maintenance fee in cents
  maintenancePaidInCash Boolean   @default(false) // This month's maintenance paid in cash
  maintenanceCashConfirmed Boolean @default(false) // Admin confirmed maintenance cash payment
  maintenanceCashConfirmedAt DateTime? // When confirmed
  nextMaintenanceDue    DateTime? // Next maintenance payment due date
  
  // User response to quote
  userAcceptedAt  DateTime?
  userDeclinedAt  DateTime?
  declineReason   String?   @db.Text
  
  // Project execution
  startedAt       DateTime?
  completedAt     DateTime?
  cancelledAt     DateTime?
  cancelReason    String?   @db.Text
  
  // Deliverables
  deliverables    String?   @db.Text // JSON or description of what was delivered
  
  status          ProjectStatus @default(PENDING)
  priority        ProjectPriority @default(NORMAL)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  quotedBy  User?            @relation("QuotedProjects", fields: [quotedById], references: [id])
  messages  ProjectMessage[]
  
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

enum ProjectStatus {
  PENDING      // User submitted, waiting for CVT review
  QUOTED       // CVT has provided a quote
  ACCEPTED     // User accepted the quote
  DECLINED     // User declined the quote
  IN_PROGRESS  // Work has started
  ON_HOLD      // Temporarily paused
  COMPLETED    // Project delivered
  CANCELLED    // Cancelled by either party
}

enum ProjectPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// Project Messages - Communication thread for a project
model ProjectMessage {
  id        String   @id @default(cuid())
  projectId String
  userId    String   // Who sent the message
  message   String   @db.Text
  isInternal Boolean @default(false) // Internal notes not visible to client
  
  createdAt DateTime @default(now())
  
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user    User    @relation(fields: [userId], references: [id])
  
  @@index([projectId])
  @@index([createdAt])
}
