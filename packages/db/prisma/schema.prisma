// Christus Veritas Technologies - ERP Database Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// ORGANIZATIONS
// ============================================

model Organization {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  email     String
  phone     String?
  address   String?
  city      String?
  country   String   @default("Zimbabwe")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members        OrganizationMember[]
  billingAccount BillingAccount?
  services       Service[]
  apiKeys        ApiKey[]
  usageEvents    UsageEvent[]
  supportTickets SupportTicket[]

  @@index([slug])
  @@index([email])
}

// ============================================
// USERS & MEMBERSHIP
// ============================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  emailVerified DateTime?
  image         String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships OrganizationMember[]
  sessions    Session[]
  accounts    Account[]

  // Admin flag for CVT internal staff
  isAdmin Boolean @default(false)

  @@index([email])
}

model OrganizationMember {
  id             String     @id @default(cuid())
  organizationId String
  userId         String
  role           MemberRole @default(MEMBER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([organizationId, userId])
  @@index([organizationId])
  @@index([userId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
  BILLING
}

// ============================================
// AUTHENTICATION (better-auth compatible)
// ============================================

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
}

model Account {
  id                    String    @id @default(cuid())
  userId                String
  accountId             String
  providerId            String
  accessToken           String?
  refreshToken          String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  idToken               String?
  password              String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(cuid())
  identifier String
  value      String
  expiresAt  DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([identifier])
}

// ============================================
// BILLING
// ============================================

model BillingAccount {
  id             String               @id @default(cuid())
  organizationId String               @unique
  status         BillingAccountStatus @default(ACTIVE)

  gracePeriodDays Int     @default(14)
  balance         Decimal @default(0) @db.Decimal(10, 2)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invoices     Invoice[]
  payments     Payment[]
  credits      Credit[]

  @@index([organizationId])
  @@index([status])
}

enum BillingAccountStatus {
  ACTIVE
  OVERDUE
  SUSPENDED
}

model Invoice {
  id               String @id @default(cuid())
  billingAccountId String
  invoiceNumber    String @unique

  periodStart DateTime
  periodEnd   DateTime

  subtotal   Int
  tax        Int           @default(0)
  total      Int
  amountPaid Int           @default(0)
  amountDue  Int
  status     InvoiceStatus @default(DRAFT)

  issuedAt    DateTime?
  dueAt       DateTime?
  paidAt      DateTime?
  finalizedAt DateTime?

  paymentToken          String?   @unique
  paymentTokenExpiresAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  billingAccount BillingAccount    @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)
  lineItems      InvoiceLineItem[]
  payments       Payment[]

  @@index([billingAccountId])
  @@index([invoiceNumber])
  @@index([status])
  @@index([paymentToken])
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  PARTIAL
  OVERDUE
  VOID
}

model InvoiceLineItem {
  id          String  @id @default(cuid())
  invoiceId   String
  description String
  quantity    Int     @default(1)
  unitPrice   Int
  total       Int
  serviceId   String?

  createdAt DateTime @default(now())

  invoice Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id])

  @@index([invoiceId])
  @@index([serviceId])
}

model Payment {
  id               String        @id @default(cuid())
  billingAccountId String
  invoiceId        String?
  amount           Int
  currency         String        @default("USD")
  method           PaymentMethod
  status           PaymentStatus @default(PENDING)

  externalId     String?
  externalStatus String?

  initiatedAt DateTime  @default(now())
  completedAt DateTime?
  failedAt    DateTime?

  errorMessage String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  billingAccount BillingAccount @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)
  invoice        Invoice?       @relation(fields: [invoiceId], references: [id])

  @@index([billingAccountId])
  @@index([invoiceId])
  @@index([status])
  @@index([externalId])
}

enum PaymentMethod {
  PAYNOW_ECOCASH
  PAYNOW_ONEMONEY
  PAYNOW_INNBUCKS
  PAYNOW_VISA
  PAYNOW_MASTERCARD
  BANK_TRANSFER
  CASH
  CREDIT
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELLED
}

model Credit {
  id               String @id @default(cuid())
  billingAccountId String
  amount           Int
  reason           String
  issuedById       String?

  createdAt DateTime @default(now())

  billingAccount BillingAccount @relation(fields: [billingAccountId], references: [id], onDelete: Cascade)

  @@index([billingAccountId])
}

// ============================================
// SERVICES
// ============================================

model Service {
  id             String        @id @default(cuid())
  organizationId String
  type           ServiceType
  name           String
  hardwareSerial String?
  monthlyFee     Int
  status         ServiceStatus @default(ACTIVE)

  activatedAt DateTime  @default(now())
  suspendedAt DateTime?
  cancelledAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization      @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  lineItems    InvoiceLineItem[]

  @@index([organizationId])
  @@index([type])
  @@index([status])
  @@index([hardwareSerial])
}

enum ServiceType {
  POS_TERMINAL
  POS_MAINTENANCE
  FUTURE_PRODUCT
}

enum ServiceStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

// ============================================
// API KEYS
// ============================================

model ApiKey {
  id             String   @id @default(cuid())
  organizationId String
  name           String
  keyHash        String   @unique
  keyPrefix      String
  scopes         String[]
  isActive       Boolean  @default(true)
  rateLimit      Int      @default(1000)
  expiresAt      DateTime?
  lastUsedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  usageEvents  UsageEvent[]

  @@index([organizationId])
  @@index([keyPrefix])
  @@index([isActive])
}

// ============================================
// USAGE EVENTS
// ============================================

model UsageEvent {
  id             String   @id @default(cuid())
  organizationId String
  apiKeyId       String?
  eventType      String
  eventData      Json?
  quantity       Int      @default(1)
  timestamp      DateTime @default(now())

  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  apiKey       ApiKey?      @relation(fields: [apiKeyId], references: [id])

  @@index([organizationId])
  @@index([apiKeyId])
  @@index([eventType])
  @@index([timestamp])
}

// ============================================
// SUPPORT
// ============================================

model SupportTicket {
  id             String              @id @default(cuid())
  organizationId String
  subject        String
  description    String
  status         SupportTicketStatus @default(OPEN)
  priority       SupportPriority     @default(NORMAL)
  assignedToId   String?

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  resolvedAt DateTime?

  organization Organization     @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  messages     SupportMessage[]

  @@index([organizationId])
  @@index([status])
  @@index([assignedToId])
}

enum SupportTicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CLIENT
  RESOLVED
  CLOSED
}

enum SupportPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

model SupportMessage {
  id         String  @id @default(cuid())
  ticketId   String
  senderId   String
  message    String
  isInternal Boolean @default(false)

  createdAt DateTime @default(now())

  ticket SupportTicket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([senderId])
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  actorId    String?
  actorType  String
  action     String
  entityType String
  entityId   String
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@index([actorId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([timestamp])
}

// ============================================
// EMAIL NOTIFICATIONS
// ============================================

model EmailLog {
  id           String      @id @default(cuid())
  to           String
  subject      String
  template     String
  status       EmailStatus @default(QUEUED)
  entityType   String?
  entityId     String?
  sentAt       DateTime?
  failedAt     DateTime?
  errorMessage String?

  createdAt DateTime @default(now())

  @@index([to])
  @@index([status])
  @@index([entityType, entityId])
}

enum EmailStatus {
  QUEUED
  SENT
  FAILED
}

// ============================================
// SYSTEM SETTINGS
// ============================================

model SystemSetting {
  id    String @id @default(cuid())
  key   String @unique
  value String

  updatedAt DateTime @updatedAt

  @@index([key])
}
